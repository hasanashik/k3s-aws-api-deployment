---
- hosts: k3s_server
  become: yes
  tasks:
    - name: Install K3s server
      shell: |
        curl -sfL https://get.k3s.io | sh -
      register: k3s_server_install

    - name: Get K3s token
      shell: |
        cat /var/lib/rancher/k3s/server/node-token
      register: k3s_token

    - name: Set K3s server IP
      set_fact:
        k3s_server_ip: "{{ ansible_default_ipv4.address }}"

- hosts: k3s_agents
  become: yes
  tasks:
    - name: Install K3s agent
      shell: |
        curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars['k3s_server'][0]['k3s_server_ip'] }}:6443 K3S_TOKEN={{ hostvars['k3s_server'][0]['k3s_token']['stdout'] }} sh -
